var CamScript=function(){class CamScript{constructor(a){this.envs={concat:""},this.vars={topic:"",receive:function(a){return a},reply:function(a){return a}},this.syns={},this.topics={"":[]},this.synsRegex=null,this.wordChars="0-9a-zA-Z\xE0\xE1\u1EA3\xE3\u1EA1\u0103\u1EB1\u1EAF\u1EB3\u1EB5\u1EB7\xE2\u1EA7\u1EA5\u1EA9\u1EAB\u1EAD\u0111\xE8\xE9\u1EBB\u1EBD\u1EB9\xEA\u1EC1\u1EBF\u1EC3\u1EC5\u1EC7\xEC\xED\u1EC9\u0129\u1ECB\xF2\xF3\u1ECF\xF5\u1ECD\xF4\u1ED3\u1ED1\u1ED5\u1ED7\u1ED9\u01A1\u1EDD\u1EDB\u1EDF\u1EE1\u1EE3\xF9\xFA\u1EE7\u0169\u1EE5\u01B0\u1EEB\u1EE9\u1EED\u1EEF\u1EF1\u1EF3\xFD\u1EF7\u1EF9\u1EF5\xC0\xC1\u1EA2\xC3\u1EA0\u0102\u1EB0\u1EAE\u1EB2\u1EB4\u1EB6\xC2\u1EA6\u1EA4\u1EA8\u1EAA\u1EAC\u0110\xC8\xC9\u1EBA\u1EBC\u1EB8\xCA\u1EC0\u1EBE\u1EC2\u1EC4\u1EC6\xCC\xCD\u1EC8\u0128\u1ECA\xD2\xD3\u1ECE\xD5\u1ECC\xD4\u1ED2\u1ED0\u1ED4\u1ED6\u1ED8\u01A0\u1EDC\u1EDA\u1EDE\u1EE0\u1EE2\xD9\xDA\u1EE6\u0168\u1EE4\u01AF\u1EEA\u1EE8\u1EEC\u1EEE\u1EF0\u1EF2\xDD\u1EF6\u1EF8\u1EF4",a&&this.parse(a)}value(a){return a&&isFinite(a)?+a:a}parse(code){var parse;return code=code.trim().replace(/\n\n+/g,"\n").replace(/\n^/g,this.envs.concat).split("\n"),parse=code=>{var action,actions,args,arr,cond,condition,func,funcData,handle,i,j,k,ks,len1,line,localVars,n,name,next,nextTab,prev,prevTab,ref,regex,replies,reply,subLines,subTopicName,subs,syn,tab,tabSubLine,text,topic,trigger,triggers,val,weight;for(topic=this.topics[""],actions=null,funcData=null,condition=null,replies=null,subLines=[],tabSubLine=0,(i=j=0,len1=code.length);j<len1;i=++j)if(line=code[i],prev=code[i-1],next=code[i+1],tab=/^\t*/.exec(line)[0].length,prevTab=prev?/^\t*/.exec(prev)[0].length:0,nextTab=next?/^\t*/.exec(next)[0].length:0,funcData)funcData.body+="\n"+line,(null==next?void 0:next.startsWith("\t"))||(func=eval(coffee.compile("("+funcData.args+")->"+funcData.body,{bare:!0})),this.vars[funcData.name]=func.bind(this),funcData=null);else if(line.startsWith("env "))[,name,val]=line.match(/^env (.+) = ?(.*)$/),"version"===name?this.constructor.VERSION<val&&console.warn("Older version of CamScript"):"concat"===name?val={space:" ",newline:"\n"}[val]||"":void 0,this.envs[name]=val;else if(line.startsWith("var "))[,name,val]=line.match(/^var (.+) = ?(.*)$/),this.vars[name]=val;else if(line.startsWith("syn ")){if([,name,val]=line.match(/^syn (.+) = (.+)$/),val=[name,...val.split("|")].sort((c,a)=>a.split(" ").length-c.split(" ").length).join("|").replace(/\ /g,"\0"),this.syns[name]=val,null==next||!next.startsWith("syn ")){for(k in ref=this.syns,ref)syn=ref[k],k.includes(" ")&&(ks=k.split(" "),arr=ks.map(a=>(this.syns[a]||a).replace(/\0/g," ").split("|")),val=[],handle=(a,b)=>{var c,d,e;c=arr[b++];for(e of c)d=(1<b&&a+" "||"")+e,arr[b]?handle(d,b):val.push(d)},handle("",0),val=_.uniq(val.concat(syn.replace(/\0/g," ").split("|"))).sort((c,a)=>a.split(" ").length-c.split(" ").length).join("|").replace(/\ /g,"\0"),this.syns[k]=val);val=Object.keys(this.syns).sort((c,a)=>a.split(" ").length-c.split(" ").length).join("|"),this.synsRegex=RegExp(`(?<=[^${this.wordChars}]|^)(${val})(?=[^${this.wordChars}]|$)`,"g")}}else if(line.startsWith("func "))[,name,args=""]=line.match(/^func (\w+)( .+)?/),funcData={name,args,body:""};else if(/^\t*\+ /.test(line)){if(!tabSubLine&&(cond=topic!==this.topics[""]||condition,cond&&1<tab||!cond&&1===tab)){for(tabSubLine=tab;this.topics[subTopicName=_.uniqueId()];);subLines.push("topic "+subTopicName);for(reply of replies)reply.text=reply.text.replace(/\{topic=.*?\}/,"").replace(/( ?\*\d+)?$/,` {topic=${subTopicName}}$1`)}if(tabSubLine)val=line.replace(RegExp(`^\t{0,${tabSubLine-1}}`),""),subLines.push(val);else{[,regex,weight=1]=/^\t*\+ (.+?)(?: ?\*(\d+))?$/.exec(line),weight=+weight,trigger={regex:regex.replace(/\[(.+?)\]/g,"$1"),weight:weight},triggers=[trigger],/^\t*\+ /.test(prev)||(actions=[]),handle=(a,b)=>{var c,d,e,f;e=!1,c=0,d=0,f=a.substring(0,b)+a.substring(b).replace(/\[.+?\] ?/,(a,f)=>(c=f+b,d=a.length,e=!0,"")),e&&(handle(a,c+d),triggers.push({regex:f.trimRight().replace(/\[(.+?)\]/g,"$1"),weight:weight}),handle(f,c))},handle(regex,0);for(trigger of triggers){for(localVars={},subs=[],n=0,trigger.regex=` ${trigger.regex} `.replace(/\*/g,()=>(subs.push(".+"),`\x01${n++}\x02`)).replace(/_/g,()=>(subs.push("\\S+"),`\x01${n++}\x02`)).replace(/#(?!\w)/g,()=>(subs.push("\\d+"),`\x01${n++}\x02`)).replace(this.synsRegex,(a,b)=>(subs.push(`(?:${this.syns[b]})`),`\x01${n++}\x02`)).replace(/\<(.+?)\>/g,(a,b)=>(subs.push(`(?:${b.replace(/\ /g,"\0")})`),`\x01${n++}\x02`)).replace(/#(\w+)/g,(a,b)=>(val=localVars[b]?`\\k<${b}>`:(localVars[b]=!0,`(?<${b}>.+)`),subs.push(val),`\x01${n++}\x02`));/\x01\d+\x02/.test(trigger.regex);)trigger.regex=trigger.regex.replace(/\x01(\d+)\x02/g,(a,b)=>subs[b]);action={trigger:trigger,replies:[]},actions.push(action),topic.push(action)}}}else if(/^\t*\* /.test(line))tabSubLine?subLines.push(line.replace(RegExp(`^\t{0,${tabSubLine-1}}`),"")):condition=line.replace(/^\t*\* /,"").replace(/\  +/g," ").trim();else if(!/^\t*- /.test(line))line.startsWith("topic ")&&(name=line.replace("topic ",""),topic=[],this.topics[name]=topic);else if(tabSubLine)val=line.replace(RegExp(`^\t{0,${tabSubLine-1}}`),"").replace(/\{topic=.*?\}/,"").replace(/( ?\*\d+)?$/," {topic=}$1"),subLines.push(val),nextTab<tabSubLine&&(subLines.push("\t+ *","\t- {topic<=}"),tabSubLine=0);else{[,text,weight=1]=/^\t*- (.+?)(?: ?\*(\d+))?$/.exec(line),/^\t*- /.test(prev)&&tab===prevTab||(replies=[]),weight=+weight,reply={text,weight,condition},replies.push(reply);for(action of actions)action.replies.push(reply);next&&nextTab<tab&&(condition?condition=null:topic=this.topics[""])}subLines.length&&parse(subLines)},parse(code),this.envs.debug&&console.log(this),this}sortReplies(){var a,b,c;for(a in b=this.topics,b)c=b[a],c.sort((c,a)=>" .+ "===c.trigger.regex||a.trigger.weight-c.trigger.weight||a.trigger.regex.trim().split(" ").length-c.trigger.regex.trim().split(" ").length).forEach(a=>{a.trigger.regex=RegExp(a.trigger.regex.replace(/\0/g," "),"i")});return this}compileText(text,exec,isCondition){var context,contn,n,prevText,result,subs;for(subs=[],contn=!1,n=0,prevText="",context=[];prevText!==text;)prevText=text,text=text.replace(/\[(.+?)\]( ?)/g,(a,b,c)=>(context[n]=.5>Math.random()?b+c:"",subs.push(`context[${n}]`),`\x01${n++}\x02`)).replace(/\<(.+?)\>/g,(a,b)=>(context[n]=_.sample(b.split("|")),subs.push(`context[${n}]`),`\x01${n++}\x02`)).replace(/(#?)#(\w+)/g,(a,b,c)=>{var d;return d=/^\d+$/.test(c)?exec[c]:exec.groups[c],b||(d=d.toLowerCase()),context[n]=d,subs.push(`context[${n}]`),`\x01${n++}\x02`}).replace(/\{(\w+)\}/g,(a,b)=>(subs.push(`(typeof(bot._=bot.vars['${b}'])=='function'?bot._():bot._)`),`\x01${n++}\x02`)).replace(RegExp(`\\{(\\w+) ([${this.wordChars} ,\x01\x02]*)\\}`,"g"),(a,b,c)=>(null!=c&&(c=c.split(/, ?/).map(a=>/\x01\d+\x02/.test(a)?a:`'${a}'`).join(",")),subs.push(`bot.vars['${b}'](${c})`),`\x01${n++}\x02`)).replace(RegExp(`\\{(\\w+)(<?)=([${this.wordChars} \x01\x02]*)\\}`,"g"),(a,b,c,d)=>(c&&(this.vars.topic=d,contn=!0),d=/\x01\d+\x02/.test(d)?d:`'${d}'`,subs.push(`(bot.vars['${b}']=${d},'')`),`\x01${n++}\x02`));for(n=!0;/\x01\d+\x02/.test(text);)text=text.replace(/\x01(\d+)\x02/g,(a,b)=>n&&!isCondition?`\${${subs[b]}}`:subs[b]),n&&(n=!1);return isCondition?(result=eval(`(bot,context)=>(${text})`)(this,context),{result}):(text=eval(`(bot,context)=>\`${text}\``)(this,context).trim().replace(/\  +/g," "),{text,contn})}cleanMessage(a){return a=` ${a.trim()} `.replace(RegExp(`[^${this.wordChars} ]+`,"g"),"").replace(/(\S)\1{2,}/g,"$1$1").replace(/\  +/g," ").replace(/(?<= )(?!(?:agg?|lagg?|tag|bag) )([^ ]+[^n])g(?= )/g,(a,b)=>b+"ng").replace(/(?<= )([^ ]+[^n])h(?= )/g,(a,b)=>b+"nh")}reply(a){var b,c,d;return a=this.cleanMessage(this.vars.receive(a)),d="",c="\nINPUT:"+a,(b=()=>{var e,f,g,h,i,j,k,l,m;m=this.topics[this.vars.topic];for(e of m)if(i=e.trigger.regex.exec(a)){c+="\nTOPIC: "+this.vars.topic,c+="\nMATCHED:"+e.trigger.regex.source,l=null,g=_.uniq(e.replies).map(a=>a.condition).filter(a=>a);for(f of g)if(this.compileText(f,i,!0).result){l=e.replies.filter(a=>a.condition===f);break}if(l||(l=e.replies.filter(a=>!a.condition)),j=l.reduce((c,a,b)=>c.concat(Array(a.weight).fill(b)),[]),d=null==(k=l[_.sample(j)])?void 0:k.text,d){({text:d,contn:h}=this.compileText(d,i));break}}h&&b()})(),c+="\nREPLY: "+d,console.log(c.trim()),this.vars.reply(d)}}return CamScript.VERSION="1.0",CamScript}.call(this);